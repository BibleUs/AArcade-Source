<html>
	<head>
		<link rel="stylesheet" type="text/css" href="asset://ui/hud.css"></link>
		<script src="asset://ui/hud.js"></script>
		<style>
			#loadingImageContainer img
			{
				width: 512px;
				height: 512px;
				position: fixed;
				top: 0;
				left: 0;
			}
		</style>
	</head>
	<body>
		<!--
		<div class="hudHeaderContainer">
			<div class="hudHeaderRow">
				<div class="hudHeaderCell" style="text-align: left;">
					<div class="hudHeaderButtonContainer">
						<div class="hudHeaderButton helpNote" help="Return to Anarchy Arcade." onclick="aaapi.system.deactivateInputMode();">
							<img src="asset://ui/return.png" /> Return
						</div>
					</div>
				</div>
				<div class="hudHeaderCell">
					<div>
						Loading Image
					</div>
				</div>
				<div class="hudHeaderCell" style="text-align: right;">
					<div class="hudHeaderButtonContainer">
						<div class="hudHeaderButton helpNote" help="Enable menu input." onclick="aaapi.system.forceInputMode();">
							Input&nbsp;&nbsp;<img src="asset://ui/inputicon.png" />
						</div>
					</div>
				</div>
			</div>
		</div>

		<br />

-->		<div id="loadingImageContainer"></div>

		<script>
			function ImageLoader()
			{
				this.fields = ["marquee", "screen"];
				this.usedFields = [];
				this.imageContainerElem = document.body.querySelector("#loadingImageContainer");
				this.imageElem;
				
				this.item;
				this.channel = "";
				this.itemId = "";
				this.field = "";
			}

			ImageLoader.prototype.loadImage = function(channel, itemId)
			{
				this.channel = channel;
				this.itemId = itemId;

				var item = aaapi.library.getLibraryItem(itemId);
				if( !item )
				{
					console.log("Error: cannot load image for item " + itemId);

					setTimeout(function()
					{
						aaapi.system.simpleImageReady(this.channel, this.itemId, "");
					}.bind(this), 100);
					
					return;
				}
console.log(item);
console.log(channel);
console.log(item[channel]);
				this.item = item;
				this.field = this.channel;
				this.usedFields = [this.field];

				if( this.item[this.field] == "" )
				{
					var nextField = this.getNextField();
					if( !!nextField )
					{
						console.log("beta");
						this.field = this.nextField;
						this.usedFields.push(this.field);
					}
					else
					{
						this.onCompleteFailure();
						return;
					}
				}

				if( !!this.imageElem )
					this.imageContainerElem.removeChild(this.imageElem);

				this.imageElem = document.createElement("img");
				this.imageContainerElem.appendChild(this.imageElem);
				this.imageElem.addEventListener("load", this.onImageLoad.bind(this), true);
				this.imageElem.addEventListener("error", this.onImageError.bind(this), true);
				this.imageElem.src = this.item[this.field];
			};

			ImageLoader.prototype.getNextField = function()
			{
				var nextField;
				var i;
				for( i = 0; i < this.fields.length; i++ )
				{
					if(this.usedFields.indexOf(this.fields[i]) < 0 && this.item[this.fields[i]] != "")
					{
						nextField = this.fields[i];
						break;
					}
				}

				return nextField;
			};

			ImageLoader.prototype.onImageLoad = function(e)
			{
				setTimeout(function()
				{
					aaapi.system.simpleImageReady(this.channel, this.itemId, this.field);
				}.bind(this), 100);	// delay because the image doesn't appear instantly when it is done loading
			};

			ImageLoader.prototype.onCompleteFailure = function()
			{
				console.log("All images for item " + this.itemId + " failed.");

				// empty field means failed to load image
				setTimeout(function()
				{
					aaapi.system.simpleImageReady(this.channel, this.itemId, "");
				}.bind(this), 100);
			};

			ImageLoader.prototype.onImageError = function(e)
			{
				var nextField = this.getNextField();

				if( !!nextField )
				{
					this.field = nextField;
					this.usedFields.push(this.field);

					if( !!this.imageElem )
						this.imageContainerElem.removeChild(this.imageElem);

					this.imageElem = document.createElement("img");
					this.imageContainerElem.appendChild(this.imageElem);
					this.imageElem.addEventListener("load", this.onImageLoad.bind(this), true);
					this.imageElem.addEventListener("error", this.onImageError.bind(this), true);
					this.imageElem.src = this.item[this.field];
				}
				else
					this.onCompleteFailure();
			};

			var imageLoader = new ImageLoader();

			// all empty args means initialize
//			setTimeout(function()
//			{
				//aaapi.system.simpleImageReady(this.channel, this.itemId, "");
				aaapi.system.simpleImageReady("", "", "");
//			}, 100);

		</script>
	</body>
</html>