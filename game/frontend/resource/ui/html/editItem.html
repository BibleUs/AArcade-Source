<html>
	<head>
		<link rel="stylesheet" type="text/css" href="asset://ui/hud.css"></link>
		<script src="asset://ui/hud.js"></script>
		<script>
			var itemContainer;
		</script>
	</head>
	<body>
		<div class="hudHeaderContainer"></div>

		<div class="hudContent" style="width: 50%; position: fixed; left: 0; right: 0; top: 45%; -webkit-transform: translate(0, -50%);">
			<div class="hudContentHeader">
				<div class="hudContentHeaderRow">
					<div class="hudContentHeaderCell">
						<div class="hudContentHeaderButton helpNote" style="display: block;" onclick="window.location='asset://ui/items.html';" help="Go back to the previous menu.">
							&nbsp;<img src="asset://ui/backarrow.png" />&nbsp;
						</div>
					</div>
					<div class="hudContentHeaderCell" id="itemHeader">
						Edit Item
					</div>
					<div class="hudContentHeaderCell">
						<div class="hudContentHeaderButton helpNote" onclick="window.location='asset://ui/blank.html';" help="Close this menu, but leave the HUD open.">
							&nbsp;<img src="asset://ui/xicon.png" />&nbsp;
						</div>
					</div>
				</div>
			</div>
			<div id="itemContainer"></div>
		</div>

		<a href="javascript:location.reload();" class="devReload">&bull;</a>

		<script>
// http://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript
function getParameterByName(name, url) {
    if (!url) url = window.location.href;
    name = name.replace(/[\[\]]/g, "\\$&");
    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, " "));
}

			var id = getParameterByName("id");
			itemContainer = document.querySelector("#itemContainer");

			var fieldHelp = {
				"app": "(OPTIONAL) Apps are useful when Windows can't launch a particular shortcut by itself. They are similar to using \"Open With\" when launching a regular desktop shortcut, but far more powerful.",
				"description": "(OPTIONAL) A brief description of the shortcut. Not really shown anywhere, but useful for searching.",
				"download": "(OPTIONAL) An internet URI where the local file that this shortcut launches can be downloaded, if applicable.",
				"file": "The local file location or internet URI that this shortcut launches.",
				"marquee": "(OPTIONAL) A local file location or internet URI of the image to use as the marquee on this shortcut's 3D model.",
				"model": "(OPTIONAL) The recommended 3D model to use when first spawning this shortcut.",
				"preview": "(OPTIONAL) An internet URI to show on the shortcut's screen as a preview for when it gets selected.",
				"reference": "(OPTIONAL) The internet URI to a unique wiki or reference page describing this shortcut, if applicable.",
				"screen": "(OPTIONAL) A local file location or internet URI of the image to use as the screen on this shortcut's 3D model.",
				"stream": "(OPTIONAL) An internet URI where a version of this shortcut's item can be streamed, rather than launching the shortcut to the local file version, if applicable.",
				"title": "A short, unique, & descriptive title.",
				"type": "(OPTIONAL) The type of this shortcut. Useful for searching, and especially useful for shortcuts that require \"Open With\" apps to launch."
			};

			var x, help, fieldContainer, fieldKey, fieldKeyNode, fieldValue, fieldValueInput;
			var item = aaapi.library.getLibraryItem(id);
			for( var x in item )
			{
				if( x === "info" )
					continue;

				fieldContainer = document.createElement("div");
				fieldContainer.className = "fieldContainer";

				fieldKey = document.createElement("div");
				//var simpleLabel = x;
				//if( simpleLabel === "app" )
					//simpleLabel = "open with";

				fieldKeyNode = document.createTextNode(x);
				fieldKey.appendChild(fieldKeyNode);
				fieldContainer.appendChild(fieldKey);

				fieldValue = document.createElement("form");
				fieldValue.addEventListener('submit', function(e)
				{
					var elem = document.activeElement;
					e.preventDefault();

					var success = aaapi.library.updateItem(id, [elem.field, elem.value]);

					if( success )
					{
						item[elem.field] = elem.value;
						console.log("Item updated!");
					}
					else
						console.log("Item update rejected!");

					elem.blur();
				}, true);

				if( x === "type" )
				{
					var fieldValueSelect = document.createElement("select");

					var types = aaapi.library.getAllLibraryTypes();
					var y;
					for( y in types )
					{
						var type = types[y];
						var fieldValueOption = document.createElement("option");
						fieldValueOption.value = type.info.id;
						fieldValueOption.text = type.title;
						fieldValueSelect.appendChild(fieldValueOption);
					}

					fieldValueSelect.value = item[x];
					fieldValueSelect.field = x;
					fieldValueSelect.addEventListener("change", function(e)
					{
						var elem = e.target;
						
						var success = aaapi.library.updateItem(id, [elem.field, elem.value]);
						if( success )
						{
							item[elem.field] = elem.value;
							console.log("Item updated!");
						}
						else
							console.log("Item update rejected!");
					}, true);

					fieldValue.appendChild(fieldValueSelect);
				}
				else if( x === "app" )
				{
				///*
					var fieldValueSelect = document.createElement("select");
					var fieldValueOption = document.createElement("option");
					fieldValueOption.value = "";
					fieldValueOption.text = "Windows";
					fieldValueSelect.appendChild(fieldValueOption);

					var apps = aaapi.library.getAllLibraryApps();
					var app;
					var y;
					for( y in apps )
					{
						app =apps[y];
						fieldValueOption = document.createElement("option");
						fieldValueOption.value = app.info.id;
						fieldValueOption.text = app.title;
						fieldValueSelect.appendChild(fieldValueOption);
					}

					fieldValueSelect.value = item[x];
					fieldValueSelect.field = x;
					fieldValueSelect.addEventListener("change", function(e)
					{
						var elem = e.target;
						
						var success = aaapi.library.updateItem(id, [elem.field, elem.value]);
						if( success )
						{
							item[elem.field] = elem.value;
							console.log("Item updated!");
						}
						else
							console.log("Item update rejected!");
					}, true);

					fieldValue.appendChild(fieldValueSelect);
					//*/
				}
				else
				{
					//var formElem = document.createElement("form");
					//formElem.className = "fieldForm";

					fieldValueInput = document.createElement("input");
					fieldValueInput.type = "text";
					fieldValueInput.value = item[x];
					fieldValueInput.field = x;
					fieldValueInput.addEventListener('blur', function(e)
					{
						var elem = e.target;
						if( elem.value != item[elem.field] )
							elem.value = item[elem.field];
					}, true);
					fieldValue.appendChild(fieldValueInput);

					//formElem.appendChild(fieldValueInput);.
					//fieldValue.appendChild(formElem);
				}

				fieldContainer.appendChild(fieldValue);
				itemContainer.appendChild(fieldContainer);

				if( x == "file" || x == "marquee" || x == "screen" || x == "preview" )
				{
					fieldValue.style.width = "63%";

					var buttonBrowseContainer = document.createElement("div");
					buttonBrowseContainer.className = "button";
					buttonBrowseContainer.style.cssText = "font-style: normal; margin: 1px; border-radius: 6px; padding: 2px; text-align: center; vertical-align: top; margin-top: 3px;";
					buttonBrowseContainer.addEventListener("click", function(e)
					{
						aaapi.system.fileBrowse();
					}, true);
					buttonBrowseContainer.innerHTML = "<img src='browseicon.png' style='width: 20px;' />";
					fieldContainer.appendChild(buttonBrowseContainer);

					var buttonGlobeContainer = document.createElement("div");
					buttonGlobeContainer.className = "button";
					buttonGlobeContainer.style.cssText = "font-style: normal; margin: 1px; border-radius: 6px; padding: 2px; text-align: center; vertical-align: top; margin-top: 3px;";
					buttonGlobeContainer.innerHTML = "<img src='webicon.png' style='width: 20px;' />";
					buttonGlobeContainer.field = x;
					buttonGlobeContainer.addEventListener("click", function(e)
					{
						var elem = e.target;

						var queryTitle = item["title"];
						var dateCull = queryTitle.indexOf(" (");
						if( dateCull >= 0 )
							queryTitle = queryTitle.substring(0, dateCull);

						var query = "https://www.netflix.com/search/" + encodeURIComponent(queryTitle);

						aaapi.system.metaSearch(id, elem.field, query);

						document.location = "asset://ui/blank.html";
					}, true);
					fieldContainer.appendChild(buttonGlobeContainer);

					var buttonCurrentContainer = document.createElement("div");
					buttonCurrentContainer.className = "button";
					buttonCurrentContainer.style.cssText = "font-style: normal; margin: 1px; border-radius: 6px; padding: 2px; text-align: center; vertical-align: top; margin-top: 3px;";

					var buttonCurrentImage = document.createElement("img");
					buttonCurrentImage.style.cssText = "width: 20px;";
					buttonCurrentImage.src = "linkicon.png";
					buttonCurrentImage.field = x;				
					buttonCurrentImage.addEventListener("click", function(e)
					{
						arcadeHud.metaScrape("currenturi", function(scrapedData)
						{
							//console.log(this.field + " : " + scrapedData);

							if( !!scrapedData[this.field] && scrapedData[this.field] !== "" )
							{
								var inputs = document.querySelectorAll("input");
								var i;
								for( i = 0; i < inputs.length; i++ )
								{
									//console.log(inputs[i].value);
									if( inputs[i].field === this.field )
									{
										inputs[i].focus();
										inputs[i].value = "xxx" + scrapedData.reference;//arcadeHud.getURL();
										break;
									}
								}
							}
						}.bind(this));					
					}.bind(buttonCurrentImage), true);
					
					buttonCurrentContainer.appendChild(buttonCurrentImage);
					fieldContainer.appendChild(buttonCurrentContainer);
				}

				if( x == "stream" || x == "download" || x == "reference" )
				{
					fieldValue.style.width = "69%";

					var buttonGlobeContainer = document.createElement("div");
					buttonGlobeContainer.className = "button";
					buttonGlobeContainer.style.cssText = "font-style: normal; margin: 1px; border-radius: 6px; padding: 2px; text-align: center; vertical-align: top; margin-top: 3px;";
					buttonGlobeContainer.innerHTML = "<img src='webicon.png' style='width: 20px;' />";
					buttonGlobeContainer.field = x;
					buttonGlobeContainer.addEventListener("click", function(e)
					{
						var elem = e.target;

						var queryTitle = item["title"];
						var dateCull = queryTitle.indexOf(" (");
						if( dateCull >= 0 )
							queryTitle = queryTitle.substring(0, dateCull);

						//var query = "https://www.netflix.com/search/" + encodeURIComponent(queryTitle);
						var query = "http://www.themoviedb.org/search?query=" + encodeURIComponent(queryTitle);

						aaapi.system.metaSearch(id, elem.field, query);

						document.location = "asset://ui/blank.html";
					}, true);
					fieldContainer.appendChild(buttonGlobeContainer);

					var buttonCurrentContainer = document.createElement("div");
					buttonCurrentContainer.className = "button";
					buttonCurrentContainer.style.cssText = "font-style: normal; margin: 1px; border-radius: 6px; padding: 2px; text-align: center; vertical-align: top; margin-top: 3px;";

					var buttonCurrentImage = document.createElement("img");
					buttonCurrentImage.style.cssText = "width: 20px;";
					buttonCurrentImage.src = "linkicon.png";
					buttonCurrentImage.field = x;				
					buttonCurrentImage.addEventListener("click", function(e)
					{
						arcadeHud.metaScrape("currenturi", function(scrapedData)
						{
							//console.log(this.field + " : " + scrapedData);

							if( !!scrapedData[this.field] && scrapedData[this.field] !== "" )
							{
								var inputs = document.querySelectorAll("input");
								var i;
								for( i = 0; i < inputs.length; i++ )
								{
									//console.log(inputs[i].value);
									if( inputs[i].field === this.field )
									{
										inputs[i].focus();
										inputs[i].value = "xxx" + scrapedData.reference;//arcadeHud.getURL();
										break;
									}
								}
							}
						}.bind(this));					
					}.bind(buttonCurrentImage), true);

					buttonCurrentContainer.appendChild(buttonCurrentImage);	
					fieldContainer.appendChild(buttonCurrentContainer);
				}

				help = fieldHelp[x];
				if( !!help )
				{
					fieldContainer.setAttribute("help", help);
					arcadeHud.assignHelp(fieldContainer);
				}
			}

			var metaScrapeContainer = document.querySelector("#itemHeader");
			var buttonGlobeContainer = document.createElement("div");
			buttonGlobeContainer.className = "button";
			buttonGlobeContainer.style.cssText = "font-style: normal; margin: 1px; border-radius: 6px; padding: 2px; text-align: center; vertical-align: top; margin-top: 3px; display: inline-block; height: 20px;";
			buttonGlobeContainer.innerHTML = "<img src='webicon.png' style='width: 20px;' />";
			buttonGlobeContainer.field = x;
			buttonGlobeContainer.addEventListener("click", function(e)
			{
				var elem = e.target;

				var queryTitle = item["title"];
				var dateCull = queryTitle.indexOf(" (");
				if( dateCull >= 0 )
					queryTitle = queryTitle.substring(0, dateCull);

				var query = "http://www.themoviedb.org/search?query=" + encodeURIComponent(queryTitle);

				aaapi.system.metaSearch(id, elem.field, query);

				document.location = "asset://ui/blank.html";
			}, true);
			metaScrapeContainer.insertBefore(buttonGlobeContainer, metaScrapeContainer.firstChild);
			//metaScrapeContainer.appendChild(buttonGlobeContainer);

			var buttonCurrentContainer = document.createElement("div");
			buttonCurrentContainer.className = "button";
			buttonCurrentContainer.style.cssText = "font-style: normal; margin: 1px; border-radius: 6px; padding: 2px; text-align: center; vertical-align: top; margin-top: 3px; display: inline-block; height: 20px;";

			var buttonCurrentImage = document.createElement("img");
			buttonCurrentImage.style.cssText = "width: 20px;";
			buttonCurrentImage.src = "linkicon.png";
			buttonCurrentImage.field = "all";				
			buttonCurrentImage.addEventListener("click", function(e)
			{
				console.log("enterprise:");
				console.log(e.target.tagName);

				var elem = e.target;
				while( elem.tagName != "DIV" )
					elem = elem.parentNode;

				var popupId = "genericId";
				var rect = elem.getBoundingClientRect();
				var x = rect.left;
				var y = rect.top;
				//var width = rect.right - rect.left;
				var width = 220;
				var height = rect.bottom - rect.top;
				var itemHeight = height;
				var fontSize = "16";
				var selectedItem = "";
				var rightAligned = "0";

				var args = [popupId, x, y, width, height, height, fontSize, selectedItem, rightAligned];

				// the callback
				args.push(function(selectedOption)
				{
					console.log(selectedOption);
					arcadeHud.metaScrape(selectedOption, function(scrapedData)
					{
						var args = [];
						var x, field;
						for( x in scrapedData)
						{
							field = scrapedData[x];
							if( field === "" )
								continue;

							if( x === "type" )
							{
								var allTypes = aaapi.library.getAllLibraryTypes();
								var y;
								for( y in allTypes )
								{
									console.log(allTypes[y].title);
									if( allTypes[y].title === field )
									{
										field = allTypes[y].info.id;
										break;
									}
								}
							}
							
							var inputs = document.querySelectorAll("input, select");
							var i;
							for( i = 0; i < inputs.length; i++ )
							{
								if( inputs[i].field === x )
								{
									//inputs[i].focus();
									inputs[i].value = field;
									break;
								}
							}

							args.push(x);
							args.push(field);
						}

						var success = aaapi.library.updateItem(id, args);

						if( success )
						{
							var i;
							var max = args.length;
							for( i = 0; i < max; i += 2)
								item[args[i]] = args[i+1];

							console.log("Item updated!");
						}
						else
							console.log("Item update rejected!");
					}.bind(this));
				}.bind(this));

				// then add entries for each scraper...
				var scraper;
				var w;
				for( w in arcadeHud.scrapers )
				{
					var scraper = arcadeHud.scrapers[w];

					if( !!!scraper.fields.all )
						continue;

					var entry = {};
					entry.popType = "Option";
					entry.popLabel = scraper.title;
					entry.popTooltip = "";
					entry.popAction = w;
					entry.popRightToLeft = "0";
					entry.popHasDirectionalOverride = "0";
					entry.popEnabled = "0";
					entry.checked = "0";

					var z;
					for( z in entry )
						args.push(entry[z]);
				}

				arcadeHud.showScraperPopupMenu.apply(arcadeHud, args);
			}.bind(buttonCurrentImage), true);
			
			buttonCurrentContainer.appendChild(buttonCurrentImage);
			metaScrapeContainer.appendChild(buttonCurrentContainer);
		</script>
	</body>
</html>