<html>
	<head>
		<link rel="stylesheet" type="text/css" href="asset://ui/hud.css"></link>
		<script src="asset://ui/hud.js"></script>
	</head>
	<body>

		<div style="pointer-events: none; position: absolute; left: 0; top: 0; right: 0; bottom: 0;">
		<table style="width: 100%; height: 100%;">
		<tr ><td valign="middle" align="center">
		<div style="display: inline-block;">

		<script>
			var uiBack = arcadeHud.getParameterByName("uiback");
			//if( !uiBack )
			//	uiBack = "window.location='asset://ui/welcome.html';";

			var nodestyle = arcadeHud.getParameterByName("nodestyle");
			if( !nodestyle )
				nodestyle = "";

			//"node_smallwall";//node_metahood_style_a";
			var windowHeaderHTML = arcadeHud.generateWindowHeaderHTML("Library", "width: 1200px;", true, true, uiBack, "aaapi.system.deactivateInputMode();");
			document.write(windowHeaderHTML);
		</script>

		<script>
			var libraryBrowserContext = aaapi.system.getLibraryBrowserContext();
			var category = (libraryBrowserContext.category) ? libraryBrowserContext.category : "items";
			var types = aaapi.library.getAllLibraryTypes();

			var activeTabId = arcadeHud.getParameterByName("activeTabId");
			if( !activeTabId )
			{
				if( category === "items" )
					activeTabId = "items";
				else if( category === "models" )
					activeTabId = "props";
				else if( category === "apps" )
					activeTabId = "apps";
			}
			//else if( activeTabId === "apps" )
			//{
			//	category = "apps";
			//}

			if( nodestyle !== "" )
				activeTabId = "nodes";

			var windowTabsHeaderHTML = arcadeHud.generateWindowTabsHeaderHTML({
				"tabs": [
					{
						"id": "items",
						"title": "Items"
					},
					{
						"id": "props",
						"title": "Props"
					},
					{
						"id": "apps",
						"title": "Apps"
					}/*,
					{
						"id": "cabinets",
						"title": "Cabinets"
					},
					{
						"id": "maps",
						"title": "Maps"
					},
					{
						"id": "nodes",
						"title": "Nodes"
					},
					{
						"id": "types",
						"title": "Types"
					},
					{
						"id": "instances",
						"title": "Instances"
					}*/
				], "onChangeHandlerName": "tabChangeHandler", "activeTabId": activeTabId
			});
			document.write(windowTabsHeaderHTML);


			if( nodestyle !== "" )
			{
				var tabElem;
				var tabElems = document.querySelectorAll(".aaTab");
				for( var i = 0; i < tabElems.length; i++ )
				{
					tabElem = tabElems[i];
					if( tabElem.innerHTML.toLowerCase().trim() !== "nodes" )
						tabElem.style.display = "none";
				}
			}

			var initialTabSwitch = true;
			function tabChangeHandler(e)
			{
				if( activeTabId === e.targetTabId && !initialTabSwitch )
				{
					e.preventDefault();
					return;
				}

				// if this is the initial logic, then prefer the initial category value.
				if( initialTabSwitch )
				{
					if( activeTabId === "nodes" )
						targetTabId = activeTabId;
					else
					{
						var targetTabId;
						if (category === "items")
							targetTabId = "items";
						else if (category === "models")
							targetTabId = "props";
						else if (category === "apps")
							targetTabId = "apps";

						e.targetTabId = targetTabId;
					}
				}

				// if the target tab IS the current tab, ignore.
				var selectedEntry = document.querySelector(".selectedEntry");
				if( !!selectedEntry && selectedEntry.getAttribute("tabid") === e.targetTabId )

				var shouldUpdateContext = !initialTabSwitch;

				if( !initialTabSwitch )
				{
					// reset the file box
					entryValueInputElem.value = "";
					onEntryValueChange();
				}

				// reset the search box
				var searchBox = searchBoxForm.querySelector("input");
				//searchBox.value = "";	// why not carry the search term over?
				searchBox.focus();
				searchBox.select();

				// multi-purpose logic of generic methods
				// TODO: Work... elsewhere.

				var noTypesFilter = "no";
				okButtonElem.value = "OK";
				// tab-specific preparation
				if( e.targetTabId === "props" )
				{
					noTypesFilter = "no";
					browseInput.placeholder = "Click BROWSE to import a new MDL file...";
					browseInput.readOnly = false;
					browseInput.style.display = "inline-block";
					setCategory("models");
				}
				else if( e.targetTabId === "items" )
				{
					noTypesFilter = "no";
					browseInput.placeholder = "Paste URL or click BROWSE to create a new item...";
					browseInput.readOnly = false;
					browseInput.style.display = "inline-block";
					setCategory("items");
				}
				else if( e.targetTabId === "apps" )
				{
					noTypesFilter = "yes";
					browseInput.placeholder = "Click BROWSE to choose a new open-with executable...";
					browseInput.readOnly = false;
					browseInput.style.display = "inline-block";
					okButtonElem.value = "Add New";
					setCategory("apps");
				}
				else if( e.targetTabId === "nodes" )
				{
					noTypesFilter = "yes";
					browseInput.placeholder = "";
					browseInput.readOnly = true;
					browseInput.style.display = "none";
					setCategory("items", true);
				}

				// re-build the results
				libraryTable.setAttribute("category", category);
				libraryTable.setAttribute("noTypesFilter", noTypesFilter);

				activeTabId = e.targetTabId;
				startLibrarySearch(shouldUpdateContext);

				// alter the default tab switching UI behavior
				//if( !initialTabSwitch )
					e.setPseudo();

				initialTabSwitch = false;
				//activeTabId = e.targetTabId;
			}
		</script>

		<style>
			.detailsButton
			{
				padding: 1px;
				padding-left: 20px;
				padding-right: 20px;
			}

			.selectedEntry
			{
				
			}

			.resultsTable
			{
				/*border-collapse: separate;*/
				width: 100%;
				border-collapse: collapse;
			}

			.resultsTable td
			{
				border-top-style: solid;
				border-top-width: 2px;
				padding: 3px;
				height: 60px;
			}

			.resultsTable tr
			{
				box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.8);
			}

			.resultsTable tr td:first-child
			{
				border-top-left-radius: 8px;
				border-bottom-left-radius: 8px;
				width: 1%;
				white-space: nowrap;
				padding-left: 12px;
				padding-right: 20px;
				opacity: 0.5;
			}

			.resultsTable tr td:last-child
			{
				border-top-right-radius: 8px;
				border-bottom-right-radius: 8px;
				padding-left: 20px;
				padding-right: 20px;
			}

			.editButton
			{
				background: none;
				display: inline-block;
				border-style: solid;
				border-width: 0;
				vertical-align: top;
				padding: 3px;
				border-radius: 5px;
			}

			.buttonsContainer
			{
				display: none;
				float: right;
			}

			tr:hover > td > .buttonsContainer
			{
				display: inline-block;
			}

			.resultsTableContainer
			{
				padding: 2px;
				height: 400px;
				max-height: 400px;
				overflow-y: auto;
			}

			.entryTitleContainer
			{
				float: left;
				display: inline-block;
			}

			.entryTitleContainer
			{
				margin-right: 8px;
				display: inline-block;
				border-style: solid;
				border-width: 0;
				vertical-align: top;
				padding: 3px;
			}

			.entryTitle
			{
				display: inline-block;
				max-width: 750px;
				overflow-x: hidden;
				text-overflow: ellipsis;
			}

			.resultsTable tr:not(.selectedEntry) .entryTitle
			{
				text-shadow: none;
			}

			.entryFilter
			{
				display: inline-block;
				width: 100px;
				max-width: 100px;
				overflow-x: hidden;
				text-overflow: ellipsis;
			}

			.hasSelectedEntry #browseInput
			{
				/*background-color: red;*/
			}

			#libraryTable[category='models'] #filterSelectCell, #libraryTable[category='models'] #auxButton, #libraryTable[noTypesFilter='yes'] #filterSelectCell, #libraryTable[noTypesFilter='yes'] #auxButton, #libraryTable[noTypesFilter='yes'][category='props'] #browseButton, #libraryTable[noTypesFilter='yes'] #browseInput
			{
				display: none;
			}
		</style>

		<div class="aaTabContent aaThemeColorTwoHighBackgroundColor aaThemeColorTwoLowBorderColor" style="padding: 0; display: block;">
			<table id="libraryTable" category="" style="width: 100%;" cellspacing="0" cellpadding="0">
				<tr>
					<td>
						<table style="width: 100%;" cellspacing="0" cellpadding="0">
							<tr>
								<td style="padding: 4px;">
									<form id="searchBoxForm" style="padding: 0; margin: 0;">
										<input type="text" style="width: 100%;" class="aaTitleTextSizeFontSize" placeholder="Search..." />
									</form>
								</td>
								<td style="padding: 4px; width: 1%; white-space: nowrap;" id="filterSelectCell">
									<select id="filterSelect" class="aaTitleTextSizeFontSize" style="width: 100%;">
										<!--<option>All Types<option>-->
									</select>
								</td>
							</tr>
						</table>
					</td>
				</tr>
				<tr>
					<td>
						<div class="resultsTableContainer aaScrollBars">
							<table class="resultsTable" cellspacing="0" cellpadding="0">
								<tbody class="resultsBody">
								</tbody>
							</table>
						</div>
					</td>
				</tr>
				<tr>
					<td style="padding: 4px;">
						<form id="fileLocationForm" style="padding: 0; margin: 0;">
							<table style="width: 100%; border-style: solid; border-width: 2px;" cellspacing="0" cellpadding="0" class="aaThemeColorOneShadedBackground aaThemeColorOneShadedBorderColor">
								<tr>
									<td style="padding: 20px;">
										<input type="text" id="browseInput" style="margin: 0; margin-left: 10px; margin-right: 10px; padding-left: 4px; width: 100%; height: 100%; border-style: solid; border-width: 2px; box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.8);" class="fileBox aaTextSizeFontSize aaThemeColorTwoInverseShadedBorderColor" placeholder="" />
									</td>
									<td style="width: 1%; white-space: nowrap; padding: 20px; padding-left: 0px;">
										<input type="button" id="browseButton" value="Browse..." class="detailsButton aaButton aaTitleTextSizeFontSize aaTextColorTwoColor aaThemeColorTwoHoverShadedBackground aaThemeColorTwoShadedBorderColor" style="margin-left: 10px; margin-right: 10px;" onclick="browse(document.querySelector('#browseInput'), document.querySelector('#createNewButton'));" />
										<input type="button" id="auxButton" value="Scrapers" class="detailsButton aaButton aaTitleTextSizeFontSize aaTextColorTwoColor aaThemeColorTwoHoverShadedBackground aaThemeColorTwoShadedBorderColor" onclick="window.location='asset://ui/scrapers.html';" />
										<input type="submit" id="createNewButton" value="OK" class="detailsButton aaButton aaTitleTextSizeFontSize aaTextColorOneColor aaThemeColorOneHoverShadedBackground aaThemeColorOneShadedBorderColor" style="margin-left: 10px; margin-right: 10px;" disabled />
									</td>
								</tr>
							</table>
						</form>
					</td>
				</tr>
			</table>
		</div>

		<script>
			var windowTabsFooterHTML = arcadeHud.generateWindowTabsFooterHTML();
			document.write(windowTabsFooterHTML);
		</script>

		<script>
			var windowFooterHTML = arcadeHud.generateWindowFooterHTML();
			document.write(windowFooterHTML);
		</script>

		</div>
		</td></tr>
		</table>
		</div>

		<a href="javascript:location.reload();" class="devReload">&bull;&nbsp;</a>

		<script>
			var resultsBody = document.querySelector(".resultsBody");
			var libraryTable = document.querySelector("#libraryTable");
			var okButtonElem = document.querySelector("#createNewButton");
			var auxButton = document.querySelector("#auxButton");
			var browseButton = document.querySelector("#browseButton");

			// FUNCTIONS
			function onEntryValueChange(doNotDeselect)
			{
				if( entryValueInputElem.value !== "" )
				{
					okButtonElem.disabled = false;
					//okButtonElem.className = "button";
					//okButtonElem.style.backgroundColor = "rgba(250, 50, 50, 0.7)";
					//entryValueInputElem.style.border = "2px solid rgba(250, 50, 50, 0.7)";
				}
				else
				{
					okButtonElem.disabled = true;
					//entryValueInputElem.style.border = "2px solid white";
				}

				if( typeof doNotDeselect !== "boolean" || !doNotDeselect )
				{
					var selectedEntry = document.querySelector(".selectedEntry");
					if( !!selectedEntry )
						deselectLibraryEntry(selectedEntry);
				}
			}

			function browse(inputElem)
			{
				arcadeHud.browseForFile(function(chosenFile)
				{
					var categoryOverride = category;
					if( categoryOverride !== "models" && chosenFile.toLowerCase().lastIndexOf(".mdl") === chosenFile.length - 4 )
						categoryOverride = "models";

					if(chosenFile !== "")
					{
						if( categoryOverride === "models" )
						{
							if( chosenFile.toLowerCase().indexOf(".mdl") !== chosenFile.length-4 )
							{
								console.log("ERROR: Models must be MDL files.\n");
								createModalAlert("Oops!", "Models must be MDL files.", "");
								chosenFile = "";
							}
							else
							{
								var relativeFile = aaapi.system.getRelativeAssetPath(chosenFile);
								if( chosenFile === relativeFile )
								{
									console.log("ERROR: MDL must be in a mounted content folder.\n");
									createModalAlert("Oops!", "The MDL file must be in a mounted content folder.", "");
									chosenFile = "";
								}
								else
									chosenFile = relativeFile;
							}
						}

						this.value = chosenFile;
						onEntryValueChange();
						fileLocationFormElem.querySelector("input[type='submit']").click();
					}
				}.bind(inputElem));
			}

			function selectLibraryEntry(entryRow)
			{
				// select entry
				entryRow.classList.add("selectedEntry");
				//okButtonElem

				var cells = entryRow.querySelectorAll("td");
				//var entryFilterCell = cells[0];
				//var entryTitleCell = cells[1];
				var cell;
				for( var i = 0; i < cells.length; i++ )
				{
					cell = cells[i];
					cell.classList.remove("aaThemeColorTwoShadedBackground");
					cell.classList.remove("aaTextColorTwoColor");
					cell.classList.add("aaThemeColorOneShadedBackground");
					cell.classList.add("aaTextColorOneColor");
				}

				var entry = entryRow.entry;

				// update selected entry value
				var itemValue;
				if( category === "items" )
					itemValue = entry.file;
				else if( category === "models" )
					itemValue = entry.platforms[arcadeHud.platformId].file;
				else if( category === "apps" )
					itemValue = "";
				entryValueInputElem.value = itemValue;
				onEntryValueChange(true);

				console.log(entryRow.entry.info.id)

				libraryTable.classList.add("hasSelectedEntry");

				/*
				// FIXME: this always assumes category "items"

				// Remove the disabledButton class
				// FIXME: Need a more generalized way to toggle the buttons
				var button = document.querySelector("#editButton");
				button.className = button.className.replace(/\bdisabledButton\b/,'');

				button = document.querySelector("#launchButton");
				button.className = button.className.replace(/\bdisabledButton\b/,'');

				// adjust the entry's style
				elem.oldBgColor = elem.style.backgroundColor;
				elem.style.backgroundColor = "rgba(250, 50, 50, 0.7)";

				// select
				libraryContainer.selectedEntry = elem;

				// update selected entry value
				var itemValue;
				if( category === "items" )
					itemValue = elem.entry.file;
				else if( category === "models" )
					itemValue = elem.entry.platforms[arcadeHud.platformId].file;
				entryValueInputElem.value = itemValue;
				onEntryValueChange(true);
				*/
			}

			function deselectLibraryEntry(entryRow)
			{
				if( !!!entryRow )
					return;

				// deselect entry
				entryRow.classList.remove("selectedEntry");

				var cells = entryRow.querySelectorAll("td");
				//var entryFilterCell = cells[0];
				//var entryTitleCell = cells[1];
				var cell;
				for( var i = 0; i < cells.length; i++ )
				{
					cell = cells[i];
					cell.classList.remove("aaThemeColorOneShadedBackground");
					cell.classList.remove("aaTextColorOneColor");
					cell.classList.add("aaThemeColorTwoShadedBackground");
					cell.classList.add("aaTextColorTwoColor");
				}

				libraryTable.classList.remove("hasSelectedEntry");
			}

			function startLibrarySearch(updateContext)
			{
				// empty the list & reset action button states
				var selectedEntry = document.querySelector(".selectedEntry");
				if( !!selectedEntry )
					deselectLibraryEntry(selectedEntry);

				clearRepeaterHandle();
				clearList();

				var searchElem = searchBoxForm.querySelector("input");
				var filterText = filterSelect.value;
				if( category !== "items" )	// disable filters for non-items for now.
					filterText = "";

				if( typeof updateContext !== "boolean" || updateContext )
				{
					var searchText = searchElem.value;
					aaapi.system.setLibraryBrowserContext(category, "", searchText, filterText);
				}

				// now figure out if we are finding or getting
				var response;	// response = {"success": BOOL, "entry": OBJECT, "queryId": STRING}
				var method;
				if( searchElem.value !== "" || filterText !== "")
				{
					method = "find";

					if( filterText === "" )
						response = aaapi.library.findFirstLibraryEntry(category, "title", searchElem.value);
					else
					{
						if( activeTabId !== "nodes" || nodestyle === "" )
						{
							console.log(filterText);
							response = aaapi.library.findFirstLibraryEntry(category, "title", searchElem.value, "type", filterText);//, "nodestyle", "node_highrise_studio");
						}
						else
						{
							response = aaapi.library.findFirstLibraryEntry(category, "title", searchElem.value, "type", filterText, "nodestyle", nodestyle);
						}
					}
				}
				else
				{
					method = "get";
					response = aaapi.library.getFirstLibraryEntry(category);
				}

				if( !response.success )
				{
					//console.log("ERROR: FAILED TO GET LIBRARY ENTRY!");
					return;
				}

				var libraryQueryId = response.queryId;
				if( category !== "models" || response.entry.dynamic != "1" )
					appendEntry(response.entry);

				var amt = (category === "apps") ? 999 : 40;
				libraryFetch(libraryQueryId, method, amt);
			}

			function chooseSelected(selectedEntry)
			{
				// get some values that we're probably going to have to pass to AArcade
				var searchElem = searchBoxForm.querySelector("input");
				var searchText = searchElem.value;
				var filterText = filterSelect.value;

				var categoryOverride = category;					
				if( !!selectedEntry )//&& selectedEntry.entry.info.id !== "1.#INF00" )
				{
					//console.log("herererer " + selectedEntry.entry.title);
					//console.log(selectedEntry.entry.info.id);
					// entry exists
					if( categoryOverride === "items" )
					{
						var oldTransform = localStorage.getItem("trans" + selectedEntry.entry.info.id);

						if( !!!oldTransform )
							oldTransform = {};
						else
							oldTransform = JSON.parse(oldTransform);

						var modelId = oldTransform.modelId;
						if( typeof modelId === 'undefined' )
							modelId = "";

						var scale = oldTransform.scale;
						if( typeof scale === 'undefined' )
							scale = "1.0";

						var pitch = oldTransform.pitch;
						if( typeof pitch === 'undefined' )
							pitch = "0";

						var yaw = oldTransform.yaw;
						if( typeof yaw === 'undefined' )
							yaw = "0";
						
						var roll = oldTransform.roll;
						if( typeof roll === 'undefined' )
							roll = "0";
						
						var offX = oldTransform.offX;
						if( typeof offX === 'undefined' )
							offX = "0";
						
						var offY = oldTransform.offY;
						if( typeof offY === 'undefined' )
							offY = "0";
						
						var offZ = oldTransform.offZ;
						if( typeof offZ === 'undefined' )
							offZ = "0";

						// always spawn item for now.
						aaapi.system.spawnEntry(categoryOverride, selectedEntry.entry.info.id, searchText, filterText, modelId, scale, pitch, yaw, roll, offX, offY, offZ);
					}
					else
					{
						//searchText = selectedEntry.entry.title;
						//aaapi.system.setLibraryBrowserContext(categoryOverride, selectedEntry.entry.info.id, searchText, filterText);

						
						var oldTransform = localStorage.getItem("trans" + selectedEntry.entry.info.id);
						
						if( !!!oldTransform )
							oldTransform = {};
						else
							oldTransform = JSON.parse(oldTransform);

						var modelId = "";
						//var modelId = oldTransform.modelId;
						//if( typeof modelId === 'undefined' )
						//	modelId = "";

						var scale = oldTransform.scale;
						if( typeof scale === 'undefined' )
							scale = "1.0";

						var pitch = oldTransform.pitch;
						if( typeof pitch === 'undefined' )
							pitch = "0";

						var yaw = oldTransform.yaw;
						if( typeof yaw === 'undefined' )
							yaw = "0";
						
						var roll = oldTransform.roll;
						if( typeof roll === 'undefined' )
							roll = "0";
						
						var offX = oldTransform.offX;
						if( typeof offX === 'undefined' )
							offX = "0";
						
						var offY = oldTransform.offY;
						if( typeof offY === 'undefined' )
							offY = "0";
						
						var offZ = oldTransform.offZ;
						if( typeof offZ === 'undefined' )
							offZ = "0";

						aaapi.system.spawnEntry(categoryOverride, selectedEntry.entry.info.id, searchText, filterText, modelId, scale, pitch, yaw, roll, offX, offY, offZ);
					}
				}
				else if( entryValueInputElem.value !== "" )
				{
					if( categoryOverride !== "models" && entryValueInputElem.value.toLowerCase().lastIndexOf(".mdl") === entryValueInputElem.value.length - 4 )
						categoryOverride = "models";

					// entry does NOT exist yet
					if( categoryOverride === "items" )
					{
						var tunedVal = entryValueInputElem.value;
						if( tunedVal.indexOf("https") === 0 )
							tunedVal = "http" + tunedVal.substring(5);

						// first, check if an item that matches this one already exists...
			 			var item = aaapi.library.findLibraryItem("file", entryValueInputElem.value);
			 			if( !item )
			 				item = aaapi.library.findLibraryItem("refrence", entryValueInputElem.value);

						if( !item )
							item = aaapi.library.findLibraryItem("file", tunedVal);
						
			 			if( !item )
			 				item = aaapi.library.findLibraryItem("refrence", tunedVal);

			 			if( item )
			 			{
			 				aaapi.system.setLibraryBrowserContext("items", item.info.id, "", "");
			 				aaapi.system.spawnItem(item.info.id);
			 			}
			 			else
			 			{
							// start the wizard for creating a new item
							createNewItemWizard();
						}
					}
					else if( categoryOverride === "apps" )
					{
						var appFile = entryValueInputElem.value;

						var foundLastSlash = appFile.lastIndexOf("/");
						if( foundLastSlash === -1 )
							foundLastSlash = appFile.lastIndexOf("\\");
						if( foundLastSlash !== -1 )
							appTitle = appFile.substring(foundLastSlash+1);
						var foundLastDot = appTitle.lastIndexOf(".");
						if( foundLastDot !== -1 )
							appTitle = appTitle.substring(0, foundLastDot);

						// first, check if an app that matches this one already exists...
			 			var app = aaapi.library.findLibraryApp("file", appFile);
			 			//if( !app )
			 			//	app = aaapi.library.findLibraryApp("title", appTitle);

			 			if( app )
			 			{
			 				console.log("App already exists!!");
			 				window.location = "asset://ui/editApp.html?id=" + encodeURIComponent(app.info.id) + "&uiback=" + encodeURIComponent("window.location='asset://ui/libraryBrowser.html?activeTabId=apps';");
			 			}
			 			else
			 			{
							app = aaapi.library.createApp("title", appTitle, "file", appFile);
							if( app )
							{
								window.location = "asset://ui/editApp.html?id=" + encodeURIComponent(app.info.id) + "&uiback=" + encodeURIComponent("window.location='asset://ui/libraryBrowser.html?activeTabId=apps';");
							}
						}
					}
					else
					{
						// first, check if an item that matches this one already exists...
						var model = aaapi.library.findLibraryModel("file", entryValueInputElem.value);

			 			if( !model )
			 				model = aaapi.library.createModel("file", entryValueInputElem.value);

			 			if( model )
			 			{
			 				//aaapi.system.setLibraryBrowserContext("models", model.info.id, "", "");
			 				//aaapi.system.spawnEntry(model.info.id);
			 				var oldTransform = localStorage.getItem("trans" + model.info.id);
						
							if( !!!oldTransform )
								oldTransform = {};
							else
								oldTransform = JSON.parse(oldTransform);

							var modelId = "";
							//var modelId = oldTransform.modelId;
							//if( typeof modelId === 'undefined' )
							//	modelId = "";

							var scale = oldTransform.scale;
							if( typeof scale === 'undefined' )
								scale = "1.0";

							var pitch = oldTransform.pitch;
							if( typeof pitch === 'undefined' )
								pitch = "0";

							var yaw = oldTransform.yaw;
							if( typeof yaw === 'undefined' )
								yaw = "0";
							
							var roll = oldTransform.roll;
							if( typeof roll === 'undefined' )
								roll = "0";
							
							var offX = oldTransform.offX;
							if( typeof offX === 'undefined' )
								offX = "0";
							
							var offY = oldTransform.offY;
							if( typeof offY === 'undefined' )
								offY = "0";
							
							var offZ = oldTransform.offZ;
							if( typeof offZ === 'undefined' )
								offZ = "0";

							aaapi.system.spawnEntry("models", model.info.id, searchText, filterText, modelId, scale, pitch, yaw, roll, offX, offY, offZ);
			 			}
					}
				}
			}

			function createNewItemWizard()
			{
				document.location = "asset://ui/createItem.html?fileLocation=" + encodeURIComponent(entryValueInputElem.value);
			}
/*
			function createNewModelWizard()
			{
				document.location = "asset://ui/createModel.html?fileLocation=" + encodeURIComponent(entryValueInputElem.value);
			}
			*/

			function editSelected()
			{
				console.log("UPDATE THIS METHOD!");
				if( !libraryContainer.selectedEntry || entryValueInputElem.value !== libraryContainer.selectedEntry.entry.file )
					return;

				if( category === "items" )
				{
					window.location = "asset://ui/editItem.html?id=" + encodeURIComponent(libraryContainer.selectedEntry.entry.info.id);
				}
				//else if( category === "apps" )
				//{
					//window.location = "asset://ui/editApp.html?id=" + encodeURIComponent(libraryContainer.selectedEntry.entry.info.id);
				//}
				else
					console.log("UNHANDLED EDIT ENTRY");
			}

			function launchSelected()
			{
				console.log("UPDATE THIS METHOD!");

				if( !libraryContainer.selectedEntry || entryValueInputElem.value !== libraryContainer.selectedEntry.entry.file )
					return;

				if( category === "items" )
				{
					window.location = "asset://ui/launchItem.html?id=" + encodeURIComponent(libraryContainer.selectedEntry.entry.info.id);
				}
				else
					console.log("UNHANDLED LAUNCH ENTRY");
			}

			// add an entry to the table
			function appendEntry(entry)
			{
				if( !!!entry )
				{
					console.log("Warning: Attempted to append an entry with no entry given.");
					return;
				}

				if( !!types[entry.type] && types[entry.type].title === "node" && activeTabId !== "nodes" )
					return;

				// add this row to the table
				var entryRow = document.createElement("tr");
				entryRow.className = "aaThemeColorTwoHoverShadedBackground";
				entryRow.entry = entry;
				entryRow.addEventListener("click", function(e)
				{
					var selectedEntry = document.querySelector(".selectedEntry");
					if( !!selectedEntry )
						deselectLibraryEntry(selectedEntry);

					selectLibraryEntry(this);
				}.bind(entryRow), true);

				//dblclick
				// issue: double click is firing even if it wasn't the SAME item you clicked twice
				// solution: what ever.
				entryRow.addEventListener("dblclick", function(e)
				{
					if( category === "apps" )
					{
						window.location = "asset://ui/editApp.html?id=" + encodeURIComponent(entryRow.entry.info.id) + "&uiback=" + encodeURIComponent("window.location='asset://ui/libraryBrowser.html?activeTabId=apps';");
					}
					else
						chooseSelected(this);
				}.bind(entryRow), true);	

				var entryFilterCell = document.createElement("td");
				entryFilterCell.className = "aaThemeColorTwoHighBorderColor aaTextSizeFontSize aaTextColorTwoColor aaTitleText";

				var entryFilterContainer = document.createElement("div");
				entryFilterContainer.className = "entryFilterContainer";

				var entryFilter = document.createElement("div");
				//entryFilter.className = "aaTextSizeFontSize aaTextColorTwoColor aaTitleText";
				entryFilter.className = "entryFilter";
				entryFilter.innerHTML = ( !!types[entry.type] ) ? types[entry.type].title : "";

				var entryTitleCell = document.createElement("td");
				entryTitleCell.className = "aaThemeColorTwoHighBorderColor aaTextColorTwoColor aaTitleTextSizeFontSize aaTitleText";

				var useImages = (category === "items");
				if( useImages )
				{
					var taskImageContainer = document.createElement("div");
					taskImageContainer.style.cssText = "display: inline-block; margin-right: 10px; vertical-align: top; width: 90px; height: 38px; text-align: center; box-shadow: 1px 1px 1px rgba(0, 0, 0, 0.8);";

					var taskImage = document.createElement("img");
					taskImage.style.display = "none";
					//taskImage.entry = task.entry;
					taskImageContainer.appendChild(taskImage);

					arcadeHud.loadItemBestImage(taskImage, entry, function()
					{
						this.ready = true;

						var imageContainer = this.parentNode;
						imageContainer.style.background = "transparent url('" + this.src + "') center";
						imageContainer.style.backgroundSize = "cover";
						//console.log(imageContainer.style.background);
						/*
						if( false && extraPanel.style.display !== "none" )
						{
							var table = document.querySelector("#dummyMarker").parentNode.parentNode.parentNode.parentNode;
							console.log(table.tagName);
							table.style.background = "transparent url('" + this.src + "')";
							table.style.backgroundSize = "cover";
						}
						*/
					});
				}

				var entryTitleContainer = document.createElement("div");
				entryTitleContainer.className = "entryTitleContainer";

				var entryTitle = document.createElement("div");
				entryTitle.className = "entryTitle";
				entryTitle.innerHTML = entry.title;

				var buttonsContainer = document.createElement("div");
				buttonsContainer.className = "buttonsContainer";

				var editButton = document.createElement("div");
				editButton.className = "editButton aaThemeColorOneHoverShadedBackground helpNote";
				editButton.setAttribute("help", "Edit this item's details.");
				editButton.entry = entry;
				editButton.addEventListener("click", function(e)
				{
					if( category === "items" )
					{
						if( nodestyle != "" )
						{
							window.location = "asset://ui/editItem.html?id=" + encodeURIComponent(this.entry.info.id) + "&uiback=" + encodeURIComponent("window.location='asset://ui/libraryBrowser.html?nodestyle=" + nodestyle + "&activeTabId=" + activeTabId + "';");
						}
						else
						{
							window.location = "asset://ui/editItem.html?id=" + encodeURIComponent(this.entry.info.id) + "&uiback=" + encodeURIComponent("window.location='asset://ui/libraryBrowser.html?activeTabId=" + activeTabId + "';");
						}
					}
					else if( category === "models" )
					{
						window.location = "asset://ui/editModel.html?id=" + encodeURIComponent(this.entry.info.id) + "&uiback=" + encodeURIComponent("window.location='asset://ui/libraryBrowser.html';");
					}
					else if( category === "apps" )
					{
						window.location = "asset://ui/editApp.html?id=" + encodeURIComponent(this.entry.info.id) + "&uiback=" + encodeURIComponent("window.location='asset://ui/libraryBrowser.html?activeTabId=apps';");
						//window.location = "asset://ui/editModel.html?id=" + encodeURIComponent(this.entry.info.id) + "&uiback=" + encodeURIComponent("window.location='asset://ui/libraryBrowser.html';");
					}
				}.bind(editButton), true);

				var editButtonImage = document.createElement("img");
				editButtonImage.src = "editicon.png";

				// compose
				// 1st cell
				entryFilterContainer.appendChild(entryFilter);
				entryFilterCell.appendChild(entryFilterContainer);

				// 2nd cell
				if( useImages )
					entryTitleContainer.appendChild(taskImageContainer);

				entryTitleContainer.appendChild(entryTitle);
				editButton.appendChild(editButtonImage);
				buttonsContainer.appendChild(editButton);
				entryTitleCell.appendChild(entryTitleContainer);
				entryTitleCell.appendChild(buttonsContainer);

				// row
				entryRow.appendChild(entryFilterCell);
				entryRow.appendChild(entryTitleCell);
				resultsBody.appendChild(entryRow);
				return;
			}

			// update the category mode of the library browser
			function setCategory(param, isNode)
			{
				if( typeof isNode === 'undefined' )
					isNode = false;

				category = param;

				if( category === "items" )
				{
					//libBrowserTypeElem.innerHTML = param;

					// also handle the filters list
					// clear the filters
					while (filterSelect.options.length)
						filterSelect.remove(0);

					// add category-specific filters
					if( category === "items" )
					{
						var fieldValueOption = document.createElement("option");
						fieldValueOption.value = "";
						fieldValueOption.text = "All Types";
						filterSelect.appendChild(fieldValueOption);

						var x;
						for( y in types )
						{
							var type = types[y];

							if( !isNode && type.title === "node" )
								continue;

							fieldValueOption = document.createElement("option");
							fieldValueOption.value = type.info.id;
							fieldValueOption.text = type.title;

							if( isNode && type.title === "node" )
								fieldValueOption.selected = true;
							else if( type.info.id === libraryBrowserContext.filter )
								fieldValueOption.selected = true;

							filterSelect.appendChild(fieldValueOption);

							if( isNode )
								filterSelect.style.display = "none";
							else
								filterSelect.style.display = "inline-block";
						}
					}
					else
					{
						// OBSOLETE? we probably don't want this anymore, because it never gets used.
						var fieldValueOption = document.createElement("option");
						fieldValueOption.value = "";
						fieldValueOption.text = "All Models";
						filterSelect.appendChild(fieldValueOption);

						// FIXME: the calls to aaapi need to be adjusted for non-type filters.
						/*
						fieldValueOption = document.createElement("option");
						fieldValueOption.value = "";
						fieldValueOption.text = "All Models";
						filterSelect.appendChild(fieldValueOption);
						*/
					}
				}
			}

			// clears out the list & also resets the action button states
			function clearList()
			{
				// clear out the contents of the search results
				while(resultsBody.firstChild)
					resultsBody.removeChild(resultsBody.firstChild);
/*
				if(libraryContainer.selectedEntry)
				{
					libraryContainer.selectedEntry = null;

					// Add the disabledButton class
					var button = document.querySelector("#editButton");
					if( button.className.search(/\bdisabledButton\b/) === -1 )
						button.className += " disabledButton";

					button = document.querySelector("#launchButton");
					if( button.className.search(/\bdisabledButton\b/) === -1 )
						button.className += " disabledButton";
				}
*/
			}

			// clear the auto-fetch interval for library searches
			function clearRepeaterHandle()
			{
				if( repeaterHandle )
				{
					clearInterval(repeaterHandle);
					repeaterHandle = null;
				}
			}

			// gets 1 entry from the AArcade backend at a time in an interval
			function libraryFetch(libraryQueryId, method, amount)
			{
				clearRepeaterHandle();

				// TODO: make the repeaterHandle part of the dummy object
				var dummy = {"queryId": libraryQueryId, "queryMethod": method, "amount": amount, "count": 0};
				repeaterHandle = setInterval(function()
				{
					var response = (this.queryMethod === "get") ? aaapi.library.getNextLibraryEntry(this.queryId, category) : aaapi.library.findNextLibraryEntry(this.queryId, category);

					if( response.success )
					{
						var libraryEntry = response.entry;
//console.log(libraryEntry.dynamic);
						if( category !== "models" || libraryEntry.dynamic != "1" )
						{
							if( this.count < this.amount )//&& libraryEntry != 0 )
							{
								appendEntry(libraryEntry);
								this.count++;
							}
						}
					}
					else
						clearRepeaterHandle();
				}.bind(dummy), 1);
			}
		</script>

		<script>
			var repeaterHandle = null;	// for library queries
			//console.log(JSON.stringify(libraryBrowserContext));
			//var category = arcadeHud.getParameterByName("category");	// still need to setCategory
			//#libraryContainer");
			var libBrowserTypeElem = document.querySelector("#libBrowserType");
			var fileLocationFormElem = document.querySelector("#fileLocationForm");
			var categorySelect = document.querySelector("#categorySelect");
			var entryValueInputElem = document.querySelector("#browseInput");
			var filterSelect = document.querySelector("#filterSelect");
			var searchBoxForm = document.querySelector("#searchBoxForm");
			searchBoxForm.querySelector("input").value = libraryBrowserContext.search;

			// listeners
			entryValueInputElem.addEventListener("input", onEntryValueChange);

			fileLocationForm.addEventListener("submit", function(e)
			{
				e.preventDefault();

				var selectedEntry = document.querySelector(".selectedEntry");
				if( !!selectedEntry )
					chooseSelected(selectedEntry);
				else if( entryValueInputElem.value !== "" )
					chooseSelected();

				return false;
			}, true);
			
			filterSelect.addEventListener("change", function(e)
			{
				startLibrarySearch();
			}, true);

			searchBoxForm.addEventListener("submit", function(e)
			{
				e.preventDefault();
				startLibrarySearch();
				return false;
			}, true);

/*
			// INITIATE THE WORK
			var categoryNames = ["items", "models"];
			var x, categoryOption;
			for( x in categoryNames )
			{
				categoryOption = document.createElement("option");
				categoryOption.value = categoryNames[x];
				categoryOption.text = categoryNames[x].charAt(0).toUpperCase() + categoryNames[x].slice(1);

				if( categoryNames[x] === libraryBrowserContext.category )
					categoryOption.selected = true;

				categorySelect.appendChild(categoryOption);
			}
*/
			//setCategory(category);
			libraryTable.setAttribute("category", category);

			var aaModalAlertMenu;
			function createModalAlert(title, text, action)
			{
				//modalWindowHeight = 700;

				if( !!aaModalAlertMenu )
				{
					console.log("ERROR: A modal alert menu is already being displayed!");
					return;
				}

				// Lets be modal.
				var modalContainer = document.createElement("div");
				modalContainer.style.cssText = "position: fixed; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.8);";
				modalContainer.addEventListener("click", function(e)
				{
					/*
					var isChild = false;
					var childNode = e.target;
					while(!!childNode)
					{
						childNode = childNode.parentNode;
						if( childNode === e.currentTarget )
						{
							isChild = true;
							break;
						}
					}
					*/

					if( e.currentTarget !== e.target )
					{
						// the modal window itself is clicked
						/*
						if( !isChild )
						{
							console.log("propo stopped");
							e.preventDefault();
							e.stopImmediatePropagation();//Immediate
						}
						*/
						return;
					}
					else
					{
						if( !!!aaModalAlertMenu.flashInterval )
						{
							aaModalAlertMenu.flashInterval = setInterval(function()
							{
								var titleRow = this.querySelector("tr");
								var titleBarElems = titleRow.querySelectorAll("td");
								var titleBarElem;

								if( !!!this.flashCount )
								{
									for( var i = 0; i < titleBarElems.length; i++ )
									{
										titleBarElem = titleBarElems[i];
										if( titleBarElem.classList.contains("aaThemeColorOneHighBackgroundColor") )
										{
											titleBarElem.classList.remove("aaThemeColorOneHighBackgroundColor");
											titleBarElem.classList.add("aaThemeColorOneBackgroundColor");
										}
									}

									clearInterval(this.flashInterval);
									delete this.flashInterval;
								}
								else
								{
									for( var i = 0; i < titleBarElems.length; i++ )
									{
										titleBarElem = titleBarElems[i];
										if( titleBarElem.classList.contains("aaThemeColorOneHighBackgroundColor") )
										{
											titleBarElem.classList.remove("aaThemeColorOneHighBackgroundColor");
											titleBarElem.classList.add("aaThemeColorOneBackgroundColor");
										}
										else if(titleBarElem.classList.contains("aaThemeColorOneBackgroundColor"))
										{
											titleBarElem.classList.remove("aaThemeColorOneBackgroundColor");
											titleBarElem.classList.add("aaThemeColorOneHighBackgroundColor");
										}
									}

									this.flashCount--;
								}
							}.bind(aaModalAlertMenu), 100);

							aaModalAlertMenu.flashCount = 6;
						}
					}
				}.bind(modalContainer), true);

				var modalHTML = "";

				// header
				//var modalYPos = parseInt(window.innerHeight / 2.2) - (modalWindowHeight / 2) + "px";
				var modalYPos = (window.innerHeight / 3) + "px";
				var modalWindowHeaderHTML = arcadeHud.generateWindowHeaderHTML(title, "margin-left: auto; margin-right: auto; top: " + modalYPos + ";", true, true, "", "");
				modalHTML += modalWindowHeaderHTML;

				// body
				modalHTML += '<div class="aaWindowPaneContentScrollable aaScrollBars aaThemeColorTwoHighBackgroundColor aaThemeColorTwoLowBorderColor aaTitleTextSizeFontSize aaTextColorTwoColor" style="">'//max-width: 700px; height: ' + modalWindowHeight + 'px; max-height: ' + modalWindowHeight + 'px;">';

				modalHTML += "<div style='font-family: Arial; text-align: justify; white-space: normal; padding: 16px;' class='aaTitleTextSizeFontSize aaTextColorTwoColor'>";
				modalHTML += text;//"Are you sure?";
				modalHTML += "</div>";
				modalHTML += "</div>";

				modalHTML += '\
					<table class="aaWindowActions">\
						<tr>\
							<td>\
							</td>\
							<td style="width: 1%; white-space: nowrap;">\
								<input type="button" class="aaButton aaTextSizeFontSize aaThemeColorTwoHoverShadedBackground aaTextColorTwoColor aaThemeColorTwoLowBorderColor" value="OK" />\
							</td>\
						</tr>\
					</table>\
				';

				// footer
				var modalWindowFooterHTML = arcadeHud.generateWindowFooterHTML();
				modalHTML += modalWindowFooterHTML;

				modalContainer.innerHTML = modalHTML;
				aaModalAlertMenu = modalContainer.querySelector(".aaWindow");
				document.body.appendChild(modalContainer);
/*
				if( !!mainHelp && mainHelp !== "" )
				{
					var mainHelpElem = modalContainer.querySelector(".aaWindowPaneContentScrollable");
					mainHelpElem.setAttribute("help", mainHelp);
					arcadeHud.assignHelp(mainHelpElem);
				}
				*/

				var buttons = modalContainer.querySelectorAll(".aaWindowActions input[type='button']");
				buttons[0].addEventListener("click", function(e)
				{
					aaModalAlertMenu.parentNode.parentNode.removeChild(aaModalAlertMenu.parentNode);
					aaModalAlertMenu = undefined;

					eval(action);
				}, true);
			}
		</script>
	</body>
</html>